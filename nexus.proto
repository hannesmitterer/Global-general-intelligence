syntax = "proto3";

package nexus;

option go_package = "github.com/hannesmitterer/nexus/proto";
option java_package = "com.nexus.proto";
option java_outer_classname = "NexusProto";

// ============================================================================
// Telemetry Services
// ============================================================================

// TelemetryService handles metrics, logs, and health data collection
service TelemetryService {
  // Stream telemetry frames (bidirectional streaming)
  rpc StreamTelemetry(stream TelemetryFrame) returns (stream TelemetryAck);
  
  // Submit a single metric
  rpc SubmitMetric(MetricFrame) returns (MetricAck);
  
  // Submit a log entry
  rpc SubmitLog(LogFrame) returns (LogAck);
  
  // Get health status
  rpc GetHealth(HealthRequest) returns (HealthResponse);
}

// TelemetryFrame represents a batch of telemetry data
message TelemetryFrame {
  string agent_id = 1;
  int64 timestamp = 2;  // Unix timestamp in milliseconds
  
  oneof payload {
    MetricFrame metrics = 3;
    LogFrame logs = 4;
    EventFrame events = 5;
  }
}

// MetricFrame contains performance and resource metrics
message MetricFrame {
  string agent_id = 1;
  int64 timestamp = 2;
  
  map<string, double> metrics = 3;  // key-value metric pairs
  map<string, string> tags = 4;     // metadata tags
}

// LogFrame contains structured log data
message LogFrame {
  string agent_id = 1;
  int64 timestamp = 2;
  LogLevel level = 3;
  string message = 4;
  map<string, string> context = 5;  // contextual data
}

enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  LOG_LEVEL_DEBUG = 1;
  LOG_LEVEL_INFO = 2;
  LOG_LEVEL_WARN = 3;
  LOG_LEVEL_ERROR = 4;
  LOG_LEVEL_FATAL = 5;
}

// EventFrame contains discrete event data
message EventFrame {
  string event_id = 1;
  string agent_id = 2;
  int64 timestamp = 3;
  string event_type = 4;
  map<string, string> data = 5;
}

// TelemetryAck acknowledges receipt of telemetry data
message TelemetryAck {
  bool success = 1;
  string message = 2;
  int64 processed_at = 3;
}

// MetricAck acknowledges metric submission
message MetricAck {
  bool success = 1;
  string metric_id = 2;
  int64 stored_at = 3;
}

// LogAck acknowledges log submission
message LogAck {
  bool success = 1;
  string log_id = 2;
  int64 stored_at = 3;
}

// HealthRequest requests system health status
message HealthRequest {
  string agent_id = 1;  // Optional: specific agent, or all if empty
}

// HealthResponse contains system health information
message HealthResponse {
  HealthStatus status = 1;
  AgentHealthStats agents = 2;
  SystemHealthStats system = 3;
}

enum HealthStatus {
  HEALTH_STATUS_UNSPECIFIED = 0;
  HEALTH_STATUS_HEALTHY = 1;
  HEALTH_STATUS_DEGRADED = 2;
  HEALTH_STATUS_UNHEALTHY = 3;
}

message AgentHealthStats {
  int32 total = 1;
  int32 active = 2;
  int32 degraded = 3;
  int32 offline = 4;
}

message SystemHealthStats {
  int64 uptime_seconds = 1;
  int64 total_requests = 2;
  double avg_response_ms = 3;
}

// ============================================================================
// Command Services
// ============================================================================

// CommandService handles agent command and control
service CommandService {
  // Issue a command to an agent
  rpc IssueCommand(CommandRequest) returns (CommandResponse);
  
  // Get command status
  rpc GetCommandStatus(CommandStatusRequest) returns (CommandStatusResponse);
  
  // Stream command updates (server-side streaming)
  rpc StreamCommandUpdates(CommandStatusRequest) returns (stream CommandUpdate);
  
  // Cancel a command
  rpc CancelCommand(CommandCancelRequest) returns (CommandCancelResponse);
}

// CommandRequest initiates a command
message CommandRequest {
  string agent_id = 1;
  string command = 2;
  map<string, string> parameters = 3;
  int32 timeout_seconds = 4;
  string idempotency_key = 5;
}

// CommandResponse acknowledges command receipt
message CommandResponse {
  string command_id = 1;
  CommandStatus status = 2;
  int64 created_at = 3;
  int32 eta_seconds = 4;
}

enum CommandStatus {
  COMMAND_STATUS_UNSPECIFIED = 0;
  COMMAND_STATUS_QUEUED = 1;
  COMMAND_STATUS_IN_PROGRESS = 2;
  COMMAND_STATUS_COMPLETED = 3;
  COMMAND_STATUS_FAILED = 4;
  COMMAND_STATUS_CANCELLED = 5;
}

// CommandStatusRequest requests command status
message CommandStatusRequest {
  string command_id = 1;
}

// CommandStatusResponse contains command execution details
message CommandStatusResponse {
  string command_id = 1;
  CommandStatus status = 2;
  CommandResult result = 3;
  int64 completed_at = 4;
}

// CommandResult contains command execution result
message CommandResult {
  bool success = 1;
  string output = 2;
  int64 duration_ms = 3;
  map<string, string> metadata = 4;
}

// CommandUpdate streams real-time command updates
message CommandUpdate {
  string command_id = 1;
  CommandStatus status = 2;
  int32 progress_percent = 3;
  string message = 4;
  int64 timestamp = 5;
}

// CommandCancelRequest requests command cancellation
message CommandCancelRequest {
  string command_id = 1;
  string reason = 2;
}

// CommandCancelResponse confirms cancellation
message CommandCancelResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================================
// Task Services
// ============================================================================

// TaskService manages distributed tasks
service TaskService {
  // Create a new task
  rpc CreateTask(CreateTaskRequest) returns (Task);
  
  // Get task details
  rpc GetTask(GetTaskRequest) returns (Task);
  
  // List tasks with filters
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
  
  // Update task status
  rpc UpdateTask(UpdateTaskRequest) returns (Task);
  
  // Delete/cancel a task
  rpc DeleteTask(DeleteTaskRequest) returns (DeleteTaskResponse);
  
  // Stream task updates
  rpc StreamTaskUpdates(StreamTaskRequest) returns (stream TaskUpdate);
}

// CreateTaskRequest initiates task creation
message CreateTaskRequest {
  string name = 1;
  string type = 2;
  TaskPriority priority = 3;
  string assigned_to = 4;
  map<string, string> parameters = 5;
  repeated string dependencies = 6;
  int64 deadline = 7;  // Unix timestamp
}

enum TaskPriority {
  TASK_PRIORITY_UNSPECIFIED = 0;
  TASK_PRIORITY_LOW = 1;
  TASK_PRIORITY_MEDIUM = 2;
  TASK_PRIORITY_HIGH = 3;
}

// Task represents a distributed task
message Task {
  string task_id = 1;
  string name = 2;
  string type = 3;
  TaskStatus status = 4;
  TaskPriority priority = 5;
  string assigned_to = 6;
  int32 progress_percent = 7;
  map<string, string> parameters = 8;
  map<string, string> result = 9;
  TaskTimeline timeline = 10;
}

enum TaskStatus {
  TASK_STATUS_UNSPECIFIED = 0;
  TASK_STATUS_PENDING = 1;
  TASK_STATUS_IN_PROGRESS = 2;
  TASK_STATUS_COMPLETED = 3;
  TASK_STATUS_FAILED = 4;
  TASK_STATUS_CANCELLED = 5;
}

// TaskTimeline tracks task lifecycle timestamps
message TaskTimeline {
  int64 created_at = 1;
  int64 started_at = 2;
  int64 completed_at = 3;
}

// GetTaskRequest retrieves a specific task
message GetTaskRequest {
  string task_id = 1;
}

// ListTasksRequest lists tasks with filters
message ListTasksRequest {
  TaskStatus status = 1;
  string assigned_to = 2;
  TaskPriority priority = 3;
  int32 limit = 4;
  int32 offset = 5;
}

// ListTasksResponse contains paginated task results
message ListTasksResponse {
  repeated Task tasks = 1;
  int32 total = 2;
  int32 limit = 3;
  int32 offset = 4;
}

// UpdateTaskRequest modifies task attributes
message UpdateTaskRequest {
  string task_id = 1;
  TaskStatus status = 2;
  int32 progress_percent = 3;
  string notes = 4;
  map<string, string> result = 5;
}

// DeleteTaskRequest removes a task
message DeleteTaskRequest {
  string task_id = 1;
}

// DeleteTaskResponse confirms task deletion
message DeleteTaskResponse {
  bool success = 1;
  string message = 2;
}

// StreamTaskRequest requests task update stream
message StreamTaskRequest {
  string task_id = 1;
}

// TaskUpdate streams real-time task updates
message TaskUpdate {
  string task_id = 1;
  TaskStatus status = 2;
  int32 progress_percent = 3;
  string message = 4;
  int64 timestamp = 5;
}

// ============================================================================
// Agent Services
// ============================================================================

// AgentService manages agent registration and discovery
service AgentService {
  // Register a new agent
  rpc RegisterAgent(RegisterAgentRequest) returns (Agent);
  
  // List available agents
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);
  
  // Get agent details
  rpc GetAgent(GetAgentRequest) returns (Agent);
  
  // Update agent status
  rpc UpdateAgentStatus(UpdateAgentStatusRequest) returns (Agent);
  
  // Heartbeat to keep agent alive
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
}

// RegisterAgentRequest initiates agent registration
message RegisterAgentRequest {
  string agent_id = 1;
  string name = 2;
  repeated string capabilities = 3;
  string endpoint = 4;
  string auth_token = 5;
}

// Agent represents a registered agent
message Agent {
  string agent_id = 1;
  string name = 2;
  AgentStatus status = 3;
  repeated string capabilities = 4;
  int32 load_percent = 5;
  int64 last_seen = 6;
}

enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_ACTIVE = 1;
  AGENT_STATUS_DEGRADED = 2;
  AGENT_STATUS_OFFLINE = 3;
}

// ListAgentsRequest retrieves agent list
message ListAgentsRequest {
  AgentStatus status = 1;  // Optional filter
}

// ListAgentsResponse contains agent list
message ListAgentsResponse {
  repeated Agent agents = 1;
}

// GetAgentRequest retrieves specific agent
message GetAgentRequest {
  string agent_id = 1;
}

// UpdateAgentStatusRequest updates agent status
message UpdateAgentStatusRequest {
  string agent_id = 1;
  AgentStatus status = 2;
  int32 load_percent = 3;
}

// HeartbeatRequest keeps agent connection alive
message HeartbeatRequest {
  string agent_id = 1;
  int32 load_percent = 2;
}

// HeartbeatResponse acknowledges heartbeat
message HeartbeatResponse {
  bool success = 1;
  int64 next_heartbeat_ms = 2;
}

// ============================================================================
// Coordination Services
// ============================================================================

// CoordinationService facilitates multi-agent collaboration
service CoordinationService {
  // Negotiate capabilities for multi-agent task
  rpc NegotiateCapabilities(NegotiationRequest) returns (NegotiationResponse);
  
  // Stream collaboration messages
  rpc Collaborate(stream CollaborationMessage) returns (stream CollaborationMessage);
}

// NegotiationRequest initiates capability negotiation
message NegotiationRequest {
  string task_type = 1;
  repeated string required_capabilities = 2;
  repeated string preferred_agents = 3;
  map<string, string> constraints = 4;
}

// NegotiationResponse assigns agents to task
message NegotiationResponse {
  string negotiation_id = 1;
  repeated AgentAssignment assigned_agents = 2;
  int64 estimated_completion = 3;
}

// AgentAssignment assigns agent to role
message AgentAssignment {
  string agent_id = 1;
  string role = 2;
  repeated string capabilities_matched = 3;
}

// CollaborationMessage facilitates inter-agent communication
message CollaborationMessage {
  string session_id = 1;
  string from_agent = 2;
  repeated string to_agents = 3;
  string message_type = 4;
  map<string, string> payload = 5;
  int64 timestamp = 6;
}
